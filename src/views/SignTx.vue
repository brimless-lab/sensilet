<template>
    <div class="panel">
        <div class="title" v-if="origin">{{$t('popup.sign_tx_request')}}</div>
        <div class="pay-info" v-if="origin">
            <div class="origin">{{ origin }}</div>
        </div>
        <div class="tx-list" v-for="txDetail in txDetailList">
            <div class="item" v-for="item in txDetail">
                <div class="info">
                    <span>{{$t('popup.tx_type')}}</span>
                    <span>{{ item.type }}</span>
                </div>
                <div class="info">
                    <span>{{$t('popup.receive_address')}}</span>
                    <span style="font-size: 12px">{{ item.address }}</span>
                </div>
                <div class="info">
                    <span>{{$t('popup.amount')}}</span>
                    <CoinShow :value="item.amount" :big-unit="item.symbol" :fixed="item.decimal" :decimal="item.decimal" show-big-unit/>
                </div>
            </div>
        </div>
        <div class="action-container" v-if="!isCreating">
            <a-button @click="cancel">{{$t('popup.cancel')}}</a-button>
            <a-button type="primary" @click="commit">{{$t('popup.commit')}}</a-button>
        </div>
        <a-spin v-else/>
    </div>
</template>

<script>

const urlParams = new URLSearchParams(window.location.hash.slice(1));
const origin = urlParams.get('origin');
const request = JSON.parse(urlParams.get('request'));
import CoinShow from "../components/CoinShow";
import txUtils from "../utils/txUtils"

export default {
    name: "Pay",
    components: {CoinShow},

    data() {

        return {
            isCreating: false,
            origin,
            fee: null,
            list: request.params.list,
            txDetailList: [],
            userAddress: walletManager.getMainAddress(),
            txTypeWord: txUtils.txTypeWord,
        }
    },
    async mounted() {
        // console.log(list)
        let list = this.list;
        if (!list || list.length <= 0)
            return this.cancel('list is empty')

        let txHexMap = {}
        for (let i = 0; i < list.length; i++) {

            if (txHexMap[list[i].txHex])
                continue

            txHexMap[list[i].txHex] = true;

            let txDetail = txUtils.getTxInfo(list[i].txHex).outputs;
            // console.log(txDetail)

            let arr = [];

            for (let j = 0; j < txDetail.length; j++) {
                let temp = {};
                temp.type = txUtils.txTypeWord[ txDetail[j].type];
                if (txDetail[j].type === txUtils.txType.SENSIBLE_FT) {


                    let data = txDetail[j].data

                    if (typeof data === 'string')
                        data = JSON.parse(data)
                    if (typeof data.tokenAmount === 'string')
                        data.tokenAmount = parseInt(data.tokenAmount);
                    temp.type += `(${data.tokenName.replaceAll('/u000','')})`;
                        temp.amount = data.decimalNum > 0 ? (data.tokenAmount / Math.pow(10, data.decimalNum)).toFixed(data.decimalNum) : data.tokenAmount;
                    temp.address = showLongString(data.tokenAddress, 20);
                    temp.symbol = data.tokenSymbol.replaceAll('/u000','');
                    temp.decimal = data.decimalNum
                } else {
                    // if(txDetail[j].address === this.userAddress){
                    //     temp.type += `(${$t('popup.change')})`
                    // }
                    temp.amount = txDetail[j].satoshis;
                    temp.address = showLongString(txDetail[j].address, 20);
                    temp.symbol = "BSV";
                    temp.decimal = 8;
                }
                arr.push(temp)
            }

            this.txDetailList.push(arr)
        }

        // console.log(this.txDetailList, '######')
        // txUtils.sign(walletManager.getMainWif(),
        //     {
        //         "txHex": "0100000001756e679201732660dd7894ac84a036cb8db3649bb066b21b44036dc79468e26c000000006b483045022100b96a586adaa056c123ab8d2cf81ad511dda0828ede5d6175074743b3f1bb74e202202a5968b1141a661c9ba98af3470e9547d69ef60589529170de69590e43d3d731412103117502b2640d3dd5d613deb73f250fdb656ada3ffd034d54bec81782aa6ee910ffffffff02e910000000000000fdee155101400176018801a901ac0873656e7369626c656001247893760114937601149376589376011493768b768b765a93760114937601400280017652012879762097dfd76851bf465e8f715593b217714858bbe9570ff3bd5e33840a34e20ff0262102ba79df5f8ae7604a9830f03c7933028186aede0675a16f025dc4f8be8eec0382210ac407f0e4bd44bfc207355a778b046225a7068fc59ee7eda43ad905aadbffc800206c266b30e6a1319c66dc401e5bd6b432ba49688eecd118297041da8074ce0810201008ce7480da41702918d1ec8e6849ba32b4d65b1e40dc669c31a1e6306b266c011c79011c79855679aa767d517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e01007e817757795679567956795679537956795479577995939521414136d08c5ed2bf3ba048afe6dcaebafeffffffffffffffffffffffffffffff006e6e977b757d009f636e937b757c68757b757c6e5296a063765279947b757c6853798277527982775452799378930130787e527e53797e57797e527e52797e5579517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7e56797e7777777777777777777777765779ac7777777777777777777769012679aa0129797601247f75547f7777880128797601687f7700005279517f75007f7d7701fd87635379537f75517f7d7701007e8177537a757b7b5379535479937f75537f777b757c677601fe87635379557f75517f7d7701007e8177537a757b7b5379555479937f75557f777b757c677601ff87635379597f75517f7d7701007e8177537a757b7b5379595479937f75597f777b757c675379517f75007f7d7701007e8177537a757b7b5379515479937f75517f777b757c686868757777777682776e0114947f77012a7982770114011493547954790114947f7554795279947f7d77012e7954796e6e0111799452947f75007f777777a97777885379012e7954796e011979947f7578011679947f77a9777788557955795379947f75557953799454947f7d7701007e817752795493537a757b7b527975567956795479947f7556795479945279011495947f775379527901149593547a7572537a537975577957795579947f75577955799453795895947f7754795379589593557a75547a547a547a547a547975587958795679947f75587956799454947f7d7701007e817701317957796e011a79940114937f7578011a79947f77777776012879012c79012c79012c790132790132790132795679a95879884f53007600a26976539f69946b6c766b796c78775279a0697d7757007600a26976539f69946b6c766b796c750117796e8b80767682778c7f75007f77777777597952798b0114957f7552790114957f7778a9886d53517600a26976539f69946b6c766b796c78775279a0697d7757517600a26976539f69946b6c766b796c750117796e8b80767682778c7f75007f77777777597952798b0114957f7552790114957f7778a9886d53527600a26976539f69946b6c766b796c78775279a0697d7757527600a26976539f69946b6c766b796c750117796e8b80767682778c7f75007f77777777597952798b0114957f7552790114957f7778a988756d6d6d6d6d0000537953a1690054799f6301327951011279957f7500011279957f7700012e007600a26976539f69946b6c766b796c7500013479788b011579957f7578011579957f7d7701007e81770136795679011479937f7556797f7d7701007e8177006ea0630138795879011679935379937f755879011679937f777768577901157953799393587a75577a577a577a577a577a577a577a5779755679787e76a87676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e7d7701007e8177775379547995567997785779979c6356798b577a75567a567a567a567a567a567a567975686d6d6d012e517600a26976539f69946b6c766b796c7551013479788b011579957f7578011579957f7d7701007e81770136795679011479937f7556797f7d7701007e8177006ea0630138795879011679935379937f755879011679937f777768577901157953799393587a75577a577a577a577a577a577a577a5779755679787e76a87676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e7d7701007e8177775379547995567997785779979c6356798b577a75567a567a567a567a567a567a567975686d6d6d012e527600a26976539f69946b6c766b796c7552013479788b011579957f7578011579957f7d7701007e81770136795679011479937f7556797f7d7701007e8177006ea0630138795879011679935379937f755879011679937f777768577901157953799393587a75577a577a577a577a577a577a577a5779755679787e76a87676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e7d7701007e8177775379547995567997785779979c6356798b577a75567a567a567a567a567a567a567975686d6d6d76539d78000000537901247f75537a757b7b5379012c7f7501247f7701007e817b757c5379012c7f77776f755279537a75537a75537a75537a755279013979510124957f75000124957f7788012d79510114957f75000114957f77012d795158957f750058957f7d7701007e8177013b790111797070012379947f75007f7752797e78586e8b80767682778c7f75007f777777777e547954797f755479012679947f777e7777777776a954798859795279935a7a75597a597a597a597a597a597a597a597a597a6d6d6d6d685154799f6301327952011279957f7551011279957f7700012e007600a26976539f69946b6c766b796c7553013479788b011579957f7578011579957f7d7701007e81770136795679011479937f7556797f7d7701007e8177006ea0630138795879011679935379937f755879011679937f777768577901157953799393587a75577a577a577a577a577a577a577a5779755679787e76a87676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e7d7701007e8177775379547995567997785779979c6356798b577a75567a567a567a567a567a567a567975686d6d6d012e517600a26976539f69946b6c766b796c75538b013479788b011579957f7578011579957f7d7701007e81770136795679011479937f7556797f7d7701007e8177006ea0630138795879011679935379937f755879011679937f777768577901157953799393587a75577a577a577a577a577a577a577a5779755679787e76a87676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e7d7701007e8177775379547995567997785779979c6356798b577a75567a567a567a567a567a567a567975686d6d6d012e527600a26976539f69946b6c766b796c75535293013479788b011579957f7578011579957f7d7701007e81770136795679011479937f7556797f7d7701007e8177006ea0630138795879011679935379937f755879011679937f777768577901157953799393587a75577a577a577a577a577a577a577a5779755679787e76a87676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e7d7701007e8177775379547995567997785779979c6356798b577a75567a567a567a567a567a567a567975686d6d6d76539d78000000537901247f75537a757b7b5379012c7f7501247f7701007e817b757c5379012c7f77776f755279537a75537a75537a75537a755279013979520124957f75510124957f7788012d79520114957f75510114957f77012d795258957f755158957f7d7701007e8177013b790111797070012379947f75007f7752797e78586e8b80767682778c7f75007f777777777e547954797f755479012679947f777e7777777776a954798859795279935a7a75597a597a597a597a597a597a597a597a597a6d6d6d6d685254799f6301327953011279957f7552011279957f7700012e007600a26976539f69946b6c766b796c755253950093013479788b011579957f7578011579957f7d7701007e81770136795679011479937f7556797f7d7701007e8177006ea0630138795879011679935379937f755879011679937f777768577901157953799393587a75577a577a577a577a577a577a577a5779755679787e76a87676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e7d7701007e8177775379547995567997785779979c6356798b577a75567a567a567a567a567a567a567975686d6d6d012e517600a26976539f69946b6c766b796c755253958b013479788b011579957f7578011579957f7d7701007e81770136795679011479937f7556797f7d7701007e8177006ea0630138795879011679935379937f755879011679937f777768577901157953799393587a75577a577a577a577a577a577a577a5779755679787e76a87676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e7d7701007e8177775379547995567997785779979c6356798b577a75567a567a567a567a567a567a567975686d6d6d012e527600a26976539f69946b6c766b796c755253955293013479788b011579957f7578011579957f7d7701007e81770136795679011479937f7556797f7d7701007e8177006ea0630138795879011679935379937f755879011679937f777768577901157953799393587a75577a577a577a577a577a577a577a5779755679787e76a87676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e777676a87e7d7701007e8177775379547995567997785779979c6356798b577a75567a567a567a567a567a567a567975686d6d6d76539d78000000537901247f75537a757b7b5379012c7f7501247f7701007e817b757c5379012c7f77776f755279537a75537a75537a75537a755279013979530124957f75520124957f7788012d79530114957f75520114957f77012d795358957f755258957f7d7701007e8177013b790111797070012379947f75007f7752797e78586e8b80767682778c7f75007f777777777e547954797f755479012679947f777e7777777776a954798859795279935a7a75597a597a597a597a597a597a597a597a597a6d6d6d6d680000587953a1690059799f635779510114957f75000114957f7757795158957f750058957f7d7701007e81777600a06952797893537a757b7b0138795e797070012079947f75007f7752797e78586e8b80767682778c7f75007f777777777e547954797f755479012379947f777e77777777012b795158957f750058957f7d7701007e81776e7658805279768277007802fd009f6378516e8b80767682778c7f75007f77777777776778030000019f6301fd5279526e8b80767682778c7f75007f777777777e7767780500000000019f6301fe5279546e8b80767682778c7f75007f777777777e776778090000000000000000019f6301ff5279586e8b80767682778c7f75007f777777777e77686868687653797e7777777e77775679787e577a75567a567a567a567a567a567a6d6d75685159799f635779520114957f75510114957f7757795258957f755158957f7d7701007e81777600a06952797893537a757b7b0138795e797070012079947f75007f7752797e78586e8b80767682778c7f75007f777777777e547954797f755479012379947f777e77777777012b795258957f755158957f7d7701007e81776e7658805279768277007802fd009f6378516e8b80767682778c7f75007f77777777776778030000019f6301fd5279526e8b80767682778c7f75007f777777777e7767780500000000019f6301fe5279546e8b80767682778c7f75007f777777777e776778090000000000000000019f6301ff5279586e8b80767682778c7f75007f777777777e77686868687653797e7777777e77775679787e577a75567a567a567a567a567a567a6d6d75685259799f635779530114957f75520114957f7757795358957f755258957f7d7701007e81777600a06952797893537a757b7b0138795e797070012079947f75007f7752797e78586e8b80767682778c7f75007f777777777e547954797f755479012379947f777e77777777012b795358957f755258957f7d7701007e81776e7658805279768277007802fd009f6378516e8b80767682778c7f75007f77777777776778030000019f6301fd5279526e8b80767682778c7f75007f777777777e7767780500000000019f6301fe5279546e8b80767682778c7f75007f777777777e776778090000000000000000019f6301ff5279586e8b80767682778c7f75007f777777777e77686868687653797e7777777e77775679787e577a75567a567a567a567a567a567a6d6d75685379789d012579827700a063012579527f75007f7702006a88012579000058805279768277007802fd009f6378516e8b80767682778c7f75007f77777777776778030000019f6301fd5279526e8b80767682778c7f75007f777777777e7767780500000000019f6301fe5279546e8b80767682778c7f75007f777777777e776778090000000000000000019f6301ff5279586e8b80767682778c7f75007f777777777e77686868687653797e7777777e77775279787e537a75777c6801277901277900527900a063780126790125797e01147e787e0126797e0124797e777654797658805279768277007802fd009f6378516e8b80767682778c7f75007f77777777776778030000019f6301fd5279526e8b80767682778c7f75007f777777777e7767780500000000019f6301fe5279546e8b80767682778c7f75007f777777777e776778090000000000000000019f6301ff5279586e8b80767682778c7f75007f777777777e77686868687653797e7777777e777777776877775279787e537a757b7b5279aa76013a797682776e58947f75780128947f77777787777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777776a4c68010000006400000000000000dc410f00000000000ef5832ac90b7e75cc5530598e5648da3b64715336521092539d313000ea730def268b522f0c588602000000777e4dd291059c9f7a0fd563f7204576dcceb7918e9c53e1a38ff28772db99ee34a23bb305062a1adc580000000000001976a91436521092539d313000ea730def268b522f0c588688ac00000000",
        //         "scriptHex": "76a91436521092539d313000ea730def268b522f0c588688ac",
        //         "address": "15xDoKMViv9CUfWxG35YhFR4FV7x1qXk7x",
        //         "inputIndex": 0,
        //         "satoshis": 30000,
        //         "sigtype": 65
        //     }
        // )

    },
    methods: {
        cancel(result = 'cancel') {
            chrome.runtime.sendMessage({
                channel: 'sato_extension_background_channel',
                data: {
                    id: request.id,
                    result: "cancel"
                },
            });
            window.close();
        },
        async commit() {
            let list = this.list;
            try {
                this.isCreating = true;

                let sigList = [];
                for (let i = 0; i < list.length; i++) {
                    sigList[i] = txUtils.sign(walletManager.getMainWif(), list[i])
                }

                chrome.runtime.sendMessage({
                    channel: 'sato_extension_background_channel',
                    data: {
                        id: request.id,
                        result: "success",
                        data: {
                            sigList
                        },
                    },
                });
                window.close();

            } catch (e) {
                console.error(e)
                antMessage.error(e.message)
            } finally {
                this.isCreating = false;
            }
        }
    }
}
</script>

<style scoped lang="scss">
.panel {
    text-align: center;

}

.title {
    font-size: 1.2em;
    font-weight: bold;
}

.genesis-container {
    margin-top: 10px;
}

.notice {
    margin: 10px;
}

.action-container {
    margin-top: 10px;

    display: flex;
    justify-content: space-between;
}

.tx-list {
    background-color: whitesmoke;
    border-radius: 5px;
    padding: 8px;

    &:not(:first-child) {
        margin-top: 10px;
    }

    .item {
        margin-top: 10px;

        .info {
            display: flex;
            justify-content: space-between;

            .address {
                font-size: 12px;
            }
        }

    }
}
</style>
